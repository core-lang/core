//= vm-args "--gc=swiper --gc-verify"

fun main() {
  var x = foo(1, foo(2, foo(3, None[Foo])));
  std::forceMinorCollect();
  x.getOrPanic().next.getOrPanic().next.getOrPanic().next = foo(4, None[Foo]);
  x = foo(100, x);
  std::forceMinorCollect();
  assert(x.getOrPanic().a == 100);
  assert(x.getOrPanic().next.getOrPanic().a == 1);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().a == 2);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().a == 3);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().a == 4);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.isNone());
}

class Foo(let a: Int32, var next: Option[Foo])

fun foo(a: Int32, next: Option[Foo]): Option[Foo] {
  Some[Foo](Foo(a, next))
}
